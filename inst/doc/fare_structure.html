<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2025-03-08" />

<title>Accounting for monetary costs</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>

<style type="text/css">
p.abstract{
text-align: center;
font-weight: bold;
}
div.abstract{
margin: auto;
width: 90%;
}
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Accounting for monetary costs</h1>
<h4 class="date">2025-03-08</h4>
<div class="abstract">
<p class="abstract">Abstract</p>
This vignette shows how to configure and use custom fare rules in order
to account for monetary travel costs when generating travel time
matrices and accessibility estimates with the <code>r5r</code> package.
</div>



<div id="introduction" class="section level1">
<h1>1. Introduction</h1>
<p>Considering the monetary costs of public transport trips in the
calculation of travel time matrices and accessibility estimates is a
major challenge faced by researchers and planning practitioners. Each
public transport system can have its own set of rules for calculating
fares, with varying levels of complexity. Moreover, there are important
trade offs between travel time and monetary costs across multiple trip
alternatives and are currently not captured by any multimodal routing
engine, except for R5.</p>
<p>R5 has native capabilities and an open architecture for creating and
including fare structures in routing models, making it possible to
estimate travel time matrices and accessibility estimates simultaneously
considering different combinations of time and monetary cost cutoffs.
The main challenge, however, is that a specific fare structure for each
city needs to be programmed in Java and tightly integrated into R5,
making this functionality out of reach for those who do not know how to
code in Java (i.e. most of us!).</p>
<p>To help tackle this challenge, <code>r5r</code> has a simple generic
rule-based fare structure that can be configured via a predefined set of
properties and rules that can be set directly from R or using external
tools such as text editors and spreadsheets. This approach currently
available in <code>r5r</code> is able to account for the monetary costs
of public transport systems that follow a simple set of fare rules
according to which the cost of a journey depends on combinations of
modes (see details below).</p>
<p><strong>This vignette shows the features of <code>r5r</code>s fare
structure. It also uses a reproducible example to demonstrate how to
configure the fare structure to account for monetary costs when
generating travel time matrices and accessibility estimates with
<code>r5r</code></strong>.</p>
<div id="details" class="section level2">
<h2>1.1 Details</h2>
<p>A common feature among many public transport services is the
possibility of discounted transfers, when passengers can use a single
ticket for a trip composed of multiple rides sometimes combining
different transport modes. Such trips usually come with a discount in
the second or subsequent fares, as well as a limit on the number of
discounted transfers the user can make and/or a time limit for using
that discount. This is the type of fare structure currently covered by
<code>r5r</code>.</p>
<p>We acknowledge that there are several types fare rules that vary from
one public transport system to another. According to these rules, the
cost of a journey can differ, for example, depending on: different costs
for each trip leg, transport mode or route; distance- or zone-based
fares; different fares for types of riders (e.g elderly people or
students) or time of the day (e.g. peak and off-peak hours); among many
others rules. As such, taking all of these possible rules into
consideration when calculating the monetary cost of multimodal can be
quite difficult. <code>r5r</code> currently does not cover these more
complex fare rules.</p>
<p>The fare calculator currently available in <code>r5r</code> is not
intended to be a robust solution that can take into consideration all
public transport systems and their specific fare rules. That would be a
Herculean task. The features included in <code>r5r</code>’s fare
calculator are inspired by our empirical observations of Brazilian
public transport systems, and is meant to be used mainly in the <a href="https://www.ipea.gov.br/acessooportunidades/en/">Access to
Opportunities project</a>. Everyone else is welcome to use it, if the
current features suit their needs.</p>
<p>obs. The GTFS format has some features for specifying public
transport fares, but those features are quite limited and are not enough
for adequately representing many use cases. A new version of that
specification is currently being developed <a href="https://github.com/google/transit/issues/252">Fares V2</a>, but it
may take some time for it to be approved and for transport agencies
actually start providing GTFS feeds with full fare information.</p>
<p><br></p>
</div>
</div>
<div id="reprex-the-public-transport-system-of-porto-alegre" class="section level1">
<h1>2. Reprex: the public transport system of Porto Alegre</h1>
<p>In this vignette, we will be using the sample data set for the city
of Porto Alegre (Brazil) included in <code>r5r</code>. Before we start,
we need to increase the memory available to Java and load the packages
used in this vignette</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">java.parameters =</span> <span class="st">&quot;-Xmx2G&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(r5r)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(h3jsr)</span></code></pre></div>
<p>Porto Alegre has a relatively straightforward public transport
system, where the vast majority of the population that rely on transit
ride buses. The city also has a metropolitan rail service that connects
the city center to the neighboring northbound municipalities. That
system can be seen in the map below.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># setup and load Porto Alegre multimodal network into memory</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co"># system.file returns the directory with example data inside the r5r package</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># set data path to directory containing your own data if not using the examples</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>data_path <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata/poa&quot;</span>, <span class="at">package =</span> <span class="st">&quot;r5r&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>r5r_core <span class="ot">&lt;-</span> <span class="fu">setup_r5</span>(data_path)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co"># load transit network as an SF</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>transit_network <span class="ot">&lt;-</span> <span class="fu">transit_network_to_sf</span>(r5r_core)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co"># map</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>transit_network<span class="sc">$</span>routes, <span class="fu">aes</span>(<span class="at">color=</span>mode)) <span class="sc">+</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p>According to the fare rules in Porto Alegre, as in most Brazilian
cities, the cost a a journey depends on a combination of number of
subsequent trips and/or transport modes. In the case of Porto Alegre,
the fare rules are as follows:</p>
<ul>
<li>Each bus ticket costs R$ 4.80.</li>
<li>Riding a second bus adds R$ 2.40 to the total cost. Subsequent bus
rides cost the full ticket price of R$ 4.80.</li>
<li>Each train ticket costs R$ 4.50. Once a passenger enters a train
station, she can take an unlimited amount of train trips as long as she
doesn’t leave a station.</li>
<li>The integrated fare between bus and train has a 10% discount, which
totals R$ 8.37.</li>
</ul>
<p>In the following sections, we will demonstrate how to implement those
rules within r5r’s fare calculator.</p>
<p><br></p>
</div>
<div id="setting-up-the-fare-structure" class="section level1">
<h1>3. Setting up the fare structure</h1>
<p>There are three support functions in <code>r5r</code> to help users
configure the fare structure:</p>
<ul>
<li><code>setup_fare_structure()</code> analyses the study area’s GTFS
and builds a ‘skeleton’ fare structure structure with the parameters
that need to be set;</li>
<li><code>write_fare_structure()</code> and
<code>read_fare_structure()</code> allow saving the current fare
structure settings to disk, and reading them back into memory. The
settings are saved as standard <code>.csv</code> files inside a zipped
folder. These files can be edited outside the R session using external
text editors and spreadsheet software, for user’s convenience.</li>
</ul>
<p>First, we need to call <code>setup_fare_structure()</code>, providing
three parameters: the current <code>r5r_core</code> object, a
<code>base_fare</code> used to populate the fare structure, and the
<code>by</code> parameters that identifies what is the main property of
the route that defines the different fares.</p>
<p>In the example below, the <code>base_fare</code> is the standard bus
ticket price of R$ 4.80. We are also stating that
<code>by = &quot;MODE&quot;</code>, so that each transport mode has its own fares
and integration rules. Users can also create a fare structure where fare
rules of routes differ by <code>&quot;AGENCY_ID&quot;</code> or
<code>&quot;AGENCY_NAME&quot;</code>, or simply set <code>by = &quot;GENERIC&quot;</code>
when the entire system follows the same rules.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>fare_structure <span class="ot">&lt;-</span> <span class="fu">setup_fare_structure</span>(r5r_core, </span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>                                       <span class="at">base_fare =</span> <span class="fl">4.8</span>,</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>                                       <span class="at">by =</span> <span class="st">&quot;MODE&quot;</span>)</span></code></pre></div>
<p>Now let’s check the contents of the <code>fare_structure</code>
object. We can see below that it is simply a <code>list</code> with a
few properties and data.frames.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">head</span>(fare_structure, <span class="at">n=</span><span class="dv">7</span>)</span></code></pre></div>
<div id="global-properties" class="section level2">
<h2>3.1 Global Properties</h2>
<p>Let’s configure the global properties first, which are the ones that
are applied to the entire system.</p>
<div id="max_discounted_transfers" class="section level3">
<h3><code>max_discounted_transfers</code></h3>
<p>Note that <code>max_discounted_transfers</code> is set to 1 by
default. This means that the passenger gets a fare discount in the first
transfer between buses, but she would pay the full fare price in
subsequent transfers.</p>
</div>
<div id="transfer_time_allowance" class="section level3">
<h3><code>transfer_time_allowance</code></h3>
<p>By default, <code>transfer_time_allowance</code> is set to 120
minutes. We have to set it to 60 minutes to fit our use case (passengers
have 60 minutes to take the second bus on a discounted fare, otherwise a
full fare is charged).</p>
</div>
<div id="fare_cap" class="section level3">
<h3><code>fare_cap</code></h3>
<p>Finally, the <code>fare_cap</code> setting indicates if there is a
maximum value that can be charged in a trip, beyond which all subsequent
rides are free of charge. In this example, we can leave
<code>fare_cap</code> set to its default <code>Inf</code> value because
this feature is not applicable to Porto Alegre.</p>
<p>Here is how we can check or update the values of these
components:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>fare_structure<span class="sc">$</span>max_discounted_transfers</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>fare_structure<span class="sc">$</span>transfer_time_allowance <span class="ot">&lt;-</span> <span class="dv">60</span> <span class="co"># update transfer_time_allowance</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>fare_structure<span class="sc">$</span>fare_cap</span></code></pre></div>
</div>
</div>
<div id="configure-fares-by-transport-mode" class="section level2">
<h2>3.2 Configure fares by transport mode</h2>
<p>To configure mode-, transfer-, and route-specific properties, we can
use the three <code>data.frames</code> inside our
<code>fare_structure</code> list. Let’s configure the modes first.
Below, we can see that the <code>fares_per_type</code> data.frame
contains five columns:</p>
<ul>
<li><code>mode</code>: the transport mode to which rules on each row
refer to;</li>
<li><code>unlimited_transfers</code>: a logical value <code>TRUE</code>
or <code>FALSE</code> that indicates if that transport mode allows
unlimited transfers between trips of the same mode, such as a
metro/subway system where the passenger pays a fare to access a station
and then can use as many services as she wants as long as she doesn’t
exit the system;</li>
<li><code>allow_same_route_transfer</code>: a logical value indicating
if a discounted transfer can be done between vehicles ??? of the same
route;</li>
<li><code>use_route_fare</code>: another logical value that indicates if
each route will have its own fare, or if all routes in this mode will
use the fare indicated in this table;</li>
<li><code>fare</code>: the full fare price of this mode.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_type</span></code></pre></div>
<p>We need to do a few small changes in the <code>fares_per_type</code>
table to accomodate the fare rules of Porto Alegre. In the
<code>&quot;RAIL&quot;</code> mode, we need to set
<code>unlimited_transfers</code> and
<code>allow_same_route_transfer</code> to <code>TRUE</code>, and update
<code>fare</code> to 4.50. In the <code>&quot;BUS&quot;</code> mode, we can let
the <code>allow_same_route_transfer</code> set to its default
<code>FALSE</code> value, because even though there is a discount for
transfers between buses (which is set in the following section), that
discount is not valid when transferring between buses within the same
route (for example, from bus route T1 to another T1). We’ll do those
changes below, using <code>data.table</code> notation.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_type[type <span class="sc">==</span> <span class="st">&quot;RAIL&quot;</span>, unlimited_transfers <span class="sc">:=</span> <span class="cn">TRUE</span>]</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_type[type <span class="sc">==</span> <span class="st">&quot;RAIL&quot;</span>, fare <span class="sc">:=</span> <span class="fl">4.50</span>]</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_type[type <span class="sc">==</span> <span class="st">&quot;RAIL&quot;</span>, allow_same_route_transfer <span class="sc">:=</span> <span class="cn">TRUE</span>]</span></code></pre></div>
<p>Checking the results below, everything looks OK:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_type</span></code></pre></div>
</div>
<div id="configure-fares-by-transfers" class="section level2">
<h2>3.3 Configure fares by transfers</h2>
<p>The fare rules for transfer are stored in the
<code>fares_per_transfer</code> data.frame, which is shown below. Each
row contains the fare prices for transfers between the modes specified
in <code>first_leg</code> and <code>second_leg</code> columns.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_transfer</span></code></pre></div>
<p>Let’s update <code>fare_per_transfer</code> to account for the actual
integration rules in Porto Alegre.</p>
<ul>
<li>The fare for “BUS” to “BUS” integration is composed of 4.80 for the
first leg plus 2.40 for the second leg, which equals to a total fare of
7.20.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># conditional update fare value</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_transfer[first_leg <span class="sc">==</span> <span class="st">&quot;BUS&quot;</span> <span class="sc">&amp;</span> second_leg <span class="sc">==</span> <span class="st">&quot;BUS&quot;</span>, fare <span class="sc">:=</span> <span class="fl">7.2</span>]</span></code></pre></div>
<ul>
<li>Transfers between “BUS” and “RAIL” (in any direction) cost 8.37,
once the 10% discount is applied. Let’s make a final update in the
data.frame to account for that.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># conditional update fare value</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_transfer[first_leg <span class="sc">!=</span> second_leg, fare <span class="sc">:=</span> <span class="fl">8.37</span>]</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># use fcase instead ?</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_transfer[, fare <span class="sc">:=</span> <span class="fu">fcase</span>(first_leg <span class="sc">==</span> <span class="st">&quot;BUS&quot;</span> <span class="sc">&amp;</span> second_leg <span class="sc">==</span> <span class="st">&quot;BUS&quot;</span>, <span class="fl">7.2</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>                                                 first_leg <span class="sc">!=</span> second_leg, <span class="fl">8.37</span>)]</span></code></pre></div>
<ul>
<li>Transfers between “RAIL” and “RAIL” are free and unlimited, which is
already accounted for in the field <code>unlimited_transfers</code> of
the <code>fare_per_mode</code> table. Thus, the equivalent row of the
<code>fare_per_transfer</code> data.frame needs to be removed. If we
leave the that row in <code>fare_per_transfer</code>, transfers between
“RAIL” and “RAIL” will count to the global
<code>max_discounted_transfers</code> allowance.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># remove row</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_transfer <span class="ot">&lt;-</span> fare_structure<span class="sc">$</span>fares_per_transfer[<span class="sc">!</span>(first_leg <span class="sc">==</span> <span class="st">&quot;RAIL&quot;</span> <span class="sc">&amp;</span> second_leg <span class="sc">==</span> <span class="st">&quot;RAIL&quot;</span>)]</span></code></pre></div>
<p>Once all changes are applied, the <code>fare_per_transfer</code>
data.frame should look like this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>fare_structure<span class="sc">$</span>fares_per_transfer</span></code></pre></div>
</div>
<div id="routes-configuration" class="section level2">
<h2>3.4 Routes configuration</h2>
<p>The information on the fare price for each route is stored in the
<code>fares_per_route</code> data.frame. Below, we can see a sample of
the bus and train routes in Porto Alegre. In case there a few special
routes (e.g. express services) with specific fares, these values can be
updated in this <code>fares_per_route</code> data.frame.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">tail</span>(fare_structure<span class="sc">$</span>fares_per_route)</span></code></pre></div>
<p>Basic route information is taken directly from the GTFS data (agency,
route id and names, mode, etc), but the <code>route_fare</code> and
<code>fare_type</code> columns were added specifically for the
<code>r5r</code> fare structure.</p>
<ul>
<li><p><code>route_fare</code>: is used to set a specific fare for each
route. This field can be used to represent services that have many
unique fares, such as metropolitan / suburban trains and buses. This is
used together with the <code>use_route_fare</code> column in the
<code>fares_per_type</code> table: the <code>route_fare</code> field is
only considered by the <code>r5r</code> fare structure when
<code>use_route_fare</code> of that mode is set to
<code>TRUE</code>.</p></li>
<li><p><code>fare_type</code>: is used to link each route with
information in the <code>fares_per_type</code> and
<code>fares_per_transfer</code> tables. In this example,
<code>fare_type</code> is always the same as <code>mode</code>, because
that was what we chose in the <code>by</code> parameter when calling
<code>setup_fare_structure</code> earlier (we could have chosen to
discriminate fares by agency, for example).</p></li>
</ul>
<p>We actually don’t have any change do to in the
<code>fares_per_route</code> table, in this example. It does not matter
that the <code>route_fare</code> value is wrong for the “RAIL” lines,
because we are using the fares set in <code>fares_per_type</code> and
<code>fares_per_transfer</code> which we already set up correctly
before.</p>
<p>Now that our <code>fare_structure</code> is complete, we can use it
to calculate travel time matrices and accessibility while accounting for
monetary cost cutoffs. Let’s see how it’s done in the next sections.</p>
</div>
</div>
<div id="calculating-travel-time-and-accessibiilty-accounting-for-monetary-costs" class="section level1">
<h1>4. Calculating travel time and accessibiilty accounting for monetary
costs</h1>
<p>The <code>travel_time_matrix()</code> and
<code>accessibility()</code> functions have two new parameters to
account for monetary costs thresholds:</p>
<ul>
<li><code>fare_structure</code>: the settings object that we’ve been
working on.</li>
<li><code>max_fare</code>: the maximum total fare that can be used in
the trip.</li>
</ul>
<div id="travel-time-with-monetary-cost" class="section level2">
<h2>4.1 Travel time with monetary cost</h2>
<p>The following example shows travel time differences when monetary
costs are accounted for, using the <code>travel_time_matrix()</code>
function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="do">## load input data</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>points <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">system.file</span>(<span class="st">&quot;extdata/poa/poa_hexgrid.csv&quot;</span>, <span class="at">package =</span> <span class="st">&quot;r5r&quot;</span>))</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># calculate travel times function</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>calculate_travel_times <span class="ot">&lt;-</span> <span class="cf">function</span>(fare) {</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  ttm_df <span class="ot">&lt;-</span> <span class="fu">travel_time_matrix</span>(</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>    r5r_core,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    <span class="at">origins =</span> points,</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    <span class="at">destinations =</span> points,</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>    <span class="at">mode =</span> <span class="fu">c</span>(<span class="st">&quot;WALK&quot;</span>, <span class="st">&quot;TRANSIT&quot;</span>),</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    <span class="at">departure_datetime =</span> <span class="fu">as.POSIXct</span>(</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>      <span class="st">&quot;13-05-2019 14:00:00&quot;</span>,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>      <span class="at">format =</span> <span class="st">&quot;%d-%m-%Y %H:%M:%S&quot;</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    ),</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>    <span class="at">time_window =</span> <span class="dv">1</span>,</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>    <span class="at">fare_structure =</span> fare_structure,</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>    <span class="at">max_fare =</span> fare,</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    <span class="at">max_trip_duration =</span> <span class="dv">40</span>,</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>    <span class="at">max_walk_time =</span> <span class="dv">20</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>  )</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="fu">return</span>(ttm_df)</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>}</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co"># calculate travel times, and combine results</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>ttm <span class="ot">&lt;-</span> <span class="fu">calculate_travel_times</span>(<span class="at">fare =</span> <span class="cn">Inf</span>)</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>ttm_500 <span class="ot">&lt;-</span> <span class="fu">calculate_travel_times</span>(<span class="at">fare =</span> <span class="dv">5</span>)</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co"># merge results</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>ttm[ttm_500, on <span class="ot">=</span> .(from_id, to_id), travel_time_500 <span class="sc">:=</span> i.travel_time_p50]</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>ttm[, travel_time_unl <span class="sc">:=</span> travel_time_p50]</span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>ttm[, travel_time_p50 <span class="sc">:=</span> <span class="cn">NULL</span>]</span></code></pre></div>
<p>Below, we can see a sample of the travel time differences with and
without monetary cost restriction. We can see that some trips are not
affected at all (<code>travel_time_unl == travel_time_500</code>), some
trips take a little longer to complete
(<code>travel_time_500 &gt; travel_time_unl</code>), and other trips
cannot be completed at all (<code>travel_time_500 == NA</code>).</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">tail</span>(ttm, <span class="dv">10</span>)</span></code></pre></div>
<p>The plots below show the overall distribution of the travel time
differences and unreachable destinations:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># plot of overall travel time differences between limited and unlimited cost travel time matrices </span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>time_difference <span class="ot">=</span> ttm[<span class="sc">!</span><span class="fu">is.na</span>(travel_time_500), .(<span class="at">count =</span> .N), </span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>                      by <span class="ot">=</span> .(travel_time_unl, travel_time_500)]</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(time_difference, <span class="fu">aes</span>(<span class="at">y =</span> travel_time_unl, <span class="at">x =</span> travel_time_500)) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">45</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">45</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;travel time (minutes)</span><span class="sc">\n</span><span class="st">unestricted monetary cost&quot;</span>,</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;travel time (minutes)</span><span class="sc">\n</span><span class="st">monetary cost restricted to BRL 5.00&quot;</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>       )</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="co"># plot of unreachable destinations when the monetary cost limit is too low</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>unreachable <span class="ot">&lt;-</span> ttm[, .(<span class="at">count =</span> .N), by <span class="ot">=</span> .(travel_time_unl, <span class="fu">is.na</span>(travel_time_500))]</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>unreachable[, perc <span class="sc">:=</span> count <span class="sc">/</span> <span class="fu">sum</span>(count, <span class="at">na.rm =</span> T), by <span class="ot">=</span> .(travel_time_unl)]</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>unreachable <span class="ot">&lt;-</span> unreachable[is.na <span class="sc">==</span> <span class="cn">TRUE</span>]</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>unreachable <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(unreachable)</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(unreachable, <span class="fu">aes</span>(<span class="at">x=</span>travel_time_unl, <span class="at">y=</span>perc)) <span class="sc">+</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">45</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.2</span>), </span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">20</span>), <span class="st">&quot;%&quot;</span>)) <span class="sc">+</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;travel time (minutes)</span><span class="sc">\n</span><span class="st">without monetary cost restriction&quot;</span>,</span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;% of unreachable destinations</span><span class="sc">\n</span><span class="st">considering a R$ 5.00 monetary cost limit&quot;</span>)</span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a><span class="co"># combine both plots using patchwork</span></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">subtitle =</span> <span class="st">&quot;Comparing travel times with and without monetary cost restriction&quot;</span>)</span></code></pre></div>
</div>
<div id="calculating-accessibility-with-monetary-cost" class="section level2">
<h2>4.2 Calculating accessibility with monetary cost</h2>
<p>Now, we can answer questions like “how many health care facilities
one can access in 60 minutes using public transport, on a R$5.00
budget?”. We’ll do that below, and compare the results the accessibility
unconstrained by monetary costs:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># calculate accessibility function</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>calculate_accessibility <span class="ot">&lt;-</span> <span class="cf">function</span>(fare, fare_string) {</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  access_df <span class="ot">&lt;-</span> <span class="fu">accessibility</span>(</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    r5r_core,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="at">origins =</span> points,</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>    <span class="at">destinations =</span> points,</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>    <span class="at">mode =</span> <span class="fu">c</span>(<span class="st">&quot;WALK&quot;</span>, <span class="st">&quot;TRANSIT&quot;</span>),</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>    <span class="at">departure_datetime =</span> <span class="fu">as.POSIXct</span>(</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>      <span class="st">&quot;13-05-2019 14:00:00&quot;</span>,</span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>      <span class="at">format =</span> <span class="st">&quot;%d-%m-%Y %H:%M:%S&quot;</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>    ),</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>    <span class="at">time_window =</span> <span class="dv">1</span>,</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>    <span class="at">opportunities_colname =</span> <span class="st">&quot;healthcare&quot;</span>,</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>    <span class="at">cutoffs =</span> <span class="dv">40</span>,</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>    <span class="at">fare_structure =</span> fare_structure,</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>    <span class="at">max_fare =</span> fare,</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>    <span class="at">max_trip_duration =</span> <span class="dv">40</span>,</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>    <span class="at">max_walk_time =</span> <span class="dv">20</span>,</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>    <span class="at">progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a>  access_df<span class="sc">$</span>max_fare <span class="ot">&lt;-</span> fare_string</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a>  <span class="fu">return</span>(access_df)</span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a>}</span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="co"># calculate accessibility, combine results, and convert to SF</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a>access_500 <span class="ot">&lt;-</span> <span class="fu">calculate_accessibility</span>(<span class="at">fare=</span><span class="dv">5</span>, <span class="at">fare_string=</span><span class="st">&quot;R$ 5.00 budget&quot;</span>)</span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>access_unl <span class="ot">&lt;-</span> <span class="fu">calculate_accessibility</span>(<span class="at">fare=</span><span class="cn">Inf</span>, <span class="at">fare_string=</span><span class="st">&quot;Unlimited budget&quot;</span>)</span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a>access <span class="ot">&lt;-</span> <span class="fu">rbind</span>(access_500, access_unl)</span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a><span class="co"># bring geometry</span></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a>access<span class="sc">$</span>geometry <span class="ot">&lt;-</span> h3jsr<span class="sc">::</span><span class="fu">cell_to_polygon</span>(access<span class="sc">$</span>id)</span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a>access <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(access)</span></code></pre></div>
<p>Finally, we can plot the results and see how accessibility levels can
differ quite substantially when we account for monetary costs.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># plot accessibility maps</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> access) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> accessibility), <span class="at">color=</span><span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">&quot;Spectral&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>max_fare) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Effect of monetary cost on accessibility&quot;</span>) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<div id="cleaning-up-after-usage" class="section level3">
<h3>Cleaning up after usage</h3>
<p><code>r5r</code> objects are still allocated to any amount of memory
previously set after they are done with their calculations. In order to
remove an existing <code>r5r</code> object and reallocate the memory it
had been using, we use the <code>stop_r5</code> function followed by a
call to Java’s garbage collector, as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>r5r<span class="sc">::</span><span class="fu">stop_r5</span>(r5r_core)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>rJava<span class="sc">::</span><span class="fu">.jgc</span>(<span class="at">R.gc =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>If you have any suggestions or want to report an error, please visit
<a href="https://github.com/ipeaGIT/r5r">the package GitHub
page</a>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
